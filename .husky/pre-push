#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸš€ Running pre-push checks..."

# Get current branch early for all checks
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

# 1. Prevent pushing to master/main
if [ "$CURRENT_BRANCH" = "master" ] || [ "$CURRENT_BRANCH" = "main" ]; then
  echo "âŒ Direct push to $CURRENT_BRANCH is not allowed"
  echo "Use pull requests for code review"
  exit 1
fi

# 2. Test ast-grep rules
echo "ğŸ” Testing ast-grep rules..."
pnpm test:ast-grep-rules || {
  echo "âŒ ast-grep rules test failed"
  echo "One or more lint rules are broken"
  echo "See ast-grep-audit-report.md for fixes"
  exit 1
}

# 3. Verify build succeeds
echo "ğŸ—ï¸  Verifying build..."
pnpm build || {
  echo "âŒ Build failed"
  echo "Fix build errors before pushing"
  exit 1
}

# 4. Check for security vulnerabilities
echo "ğŸ”’ Checking for security vulnerabilities..."
AUDIT_OUTPUT=$(pnpm audit --prod --audit-level=moderate 2>&1)
if echo "$AUDIT_OUTPUT" | grep -q "vulnerabilities"; then
  echo "âš ï¸  Security vulnerabilities found in dependencies"
  echo "$AUDIT_OUTPUT"
  echo ""
  echo "Run: pnpm audit fix"
  # Warning only, don't block push
fi

# 5. Ensure remote branch exists and is up to date
REMOTE_BRANCH=$(git rev-parse --abbrev-ref --symbolic-full-name @{u} 2>/dev/null)

if [ -n "$REMOTE_BRANCH" ]; then
  git fetch origin "$CURRENT_BRANCH" --quiet
  LOCAL=$(git rev-parse @)
  REMOTE=$(git rev-parse @{u})

  if [ "$LOCAL" != "$REMOTE" ]; then
    echo "âš ï¸  Your branch is not up to date with remote"
    echo "Run: git pull --rebase"
    # Warning only, don't block push
  fi
fi

# 6. Run smoke tests if available
if command -v pnpm test:e2e:smoke &> /dev/null; then
  echo "ğŸ§ª Running smoke tests..."
  pnpm test:e2e:smoke || {
    echo "âŒ Smoke tests failed"
    echo "Fix failing tests before pushing"
    exit 1
  }
fi

# 7. Check migration integrity if migrations exist
if git diff origin/"$CURRENT_BRANCH"..HEAD --name-only | grep -q "db/drizzle/"; then
  echo "ğŸ” Database changes detected - final migration check..."
  pnpm db:verify || {
    echo "âŒ Migration integrity check failed"
    exit 1
  }
fi

echo "âœ… All pre-push checks passed"
