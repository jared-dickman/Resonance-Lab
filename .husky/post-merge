#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ”„ Post-merge checks..."

# 1. Check if package.json changed
if git diff-tree -r --name-only --no-commit-id ORIG_HEAD HEAD | grep -q "^package.json$"; then
  echo "ğŸ“¦ package.json changed - installing dependencies..."
  pnpm install
fi

# 2. Check if schema changed
if git diff-tree -r --name-only --no-commit-id ORIG_HEAD HEAD | grep -q "db/drizzle/schema/"; then
  echo "ğŸ” Schema changed - verifying migrations are synced..."
  pnpm db:verify || {
    echo "âš ï¸  Warning: Migration drift detected after merge"
    echo "Run: pnpm drizzle-kit generate"
  }
fi

# 3. Check if migrations changed
if git diff-tree -r --name-only --no-commit-id ORIG_HEAD HEAD | grep -q "db/drizzle/migrations/"; then
  echo "ğŸ“Š Migrations changed - you may need to run migrations"
  echo "Local: pnpm drizzle-kit migrate"
fi

# 4. Check for new environment variables
if git diff-tree -r --name-only --no-commit-id ORIG_HEAD HEAD | grep -q ".env.example"; then
  echo "âš™ï¸  .env.example changed - check for new environment variables"
  echo "Update your .env.local file if needed"
fi

echo "âœ… Post-merge checks complete"
