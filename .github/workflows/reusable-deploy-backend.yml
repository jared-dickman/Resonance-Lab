name: Deploy Backend

on:
  workflow_call:
    inputs:
      environment:
        description: 'Deployment environment (production/development)'
        type: string
        required: true
      branch:
        description: 'Git branch to deploy'
        type: string
        required: true
      container_name:
        description: 'Docker container name (backend/backend-dev)'
        type: string
        required: true
      health_check_url:
        description: 'Health check endpoint URL'
        type: string
        required: true
    secrets:
      VPS_SSH_KEY:
        required: true

jobs:
  deploy-backend:
    name: Deploy Backend to ${{ inputs.environment }}
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ” Validate SSH Key Format
        run: |
          if [ -z "${{ secrets.VPS_SSH_KEY }}" ]; then
            echo "âŒ VPS_SSH_KEY secret is empty or not set"
            exit 1
          fi

          echo "${{ secrets.VPS_SSH_KEY }}" > /tmp/test_key
          chmod 600 /tmp/test_key

          echo "ğŸ“‹ Key format analysis:"
          head -1 /tmp/test_key

          if ! grep -q "BEGIN.*PRIVATE KEY" /tmp/test_key; then
            echo "âŒ SSH key doesn't contain valid BEGIN marker"
            rm -f /tmp/test_key
            exit 1
          fi

          if ! grep -q "END.*PRIVATE KEY" /tmp/test_key; then
            echo "âŒ SSH key doesn't contain valid END marker"
            rm -f /tmp/test_key
            exit 1
          fi

          # Check key format type
          if grep -q "BEGIN RSA PRIVATE KEY" /tmp/test_key; then
            echo "ğŸ”‘ Key type: RSA (PEM format)"
          elif grep -q "BEGIN OPENSSH PRIVATE KEY" /tmp/test_key; then
            echo "ğŸ”‘ Key type: OpenSSH format"
          elif grep -q "BEGIN EC PRIVATE KEY" /tmp/test_key; then
            echo "ğŸ”‘ Key type: EC (Elliptic Curve)"
          elif grep -q "BEGIN DSA PRIVATE KEY" /tmp/test_key; then
            echo "ğŸ”‘ Key type: DSA"
          fi

          # Count lines to ensure it's not truncated
          line_count=$(wc -l < /tmp/test_key)
          echo "ğŸ“ Key lines: $line_count"

          if [ "$line_count" -lt 5 ]; then
            echo "âŒ Key appears truncated (too few lines)"
            rm -f /tmp/test_key
            exit 1
          fi

          # Check for PEM passphrase encryption (old format)
          if grep -q "ENCRYPTED" /tmp/test_key; then
            echo "âš ï¸  Key is passphrase-encrypted (PEM format)"
            echo "âŒ Passphrase-encrypted keys require the 'passphrase' parameter"
            rm -f /tmp/test_key
            exit 1
          fi

          # Deep validation: try to parse the key with ssh-keygen
          echo "ğŸ”¬ Testing key parsability..."
          if ssh-keygen -y -P "" -f /tmp/test_key > /dev/null 2>&1; then
            echo "âœ… Key is valid and unencrypted"
          else
            echo "âŒ Key validation failed!"
            echo "This could mean:"
            echo "  â€¢ Key is encrypted with a passphrase (add 'passphrase' parameter)"
            echo "  â€¢ Key format is corrupted or invalid"
            echo "  â€¢ Key was not copied completely (missing content)"
            rm -f /tmp/test_key
            exit 1
          fi

          rm -f /tmp/test_key
          echo "âœ… SSH key validation passed"

      - name: ğŸ–¥ï¸ Deploy Backend to VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: srv1015344.hstgr.cloud
          username: root
          key: ${{ secrets.VPS_SSH_KEY }}
          debug: true
          script: |
            echo "ğŸ“ Deploying to: ${{ inputs.environment }}"
            echo "ğŸŒ¿ Branch: ${{ inputs.branch }}"
            echo "ğŸ“¦ Container: ${{ inputs.container_name }}"

            cd /root/Resonance-Lab
            git fetch origin
            git checkout ${{ inputs.branch }}
            git pull origin ${{ inputs.branch }}

            echo "ğŸ—ï¸ Building and starting container..."
            docker compose up -d --build ${{ inputs.container_name }}

            echo "â³ Waiting for container to be ready..."
            sleep 5

            if docker ps | grep -q ${{ inputs.container_name }}; then
              echo "âœ… Container is running"
            else
              echo "âŒ Container failed to start"
              docker logs ${{ inputs.container_name }} --tail 50
              exit 1
            fi

            echo "âœ… Backend deployed to ${{ inputs.environment }} successfully"

      - name: ğŸ¥ Health Check
        run: |
          echo "Waiting 10s for backend to start..."
          sleep 10
          if curl -f ${{ inputs.health_check_url }} > /dev/null 2>&1; then
            echo "âœ… Health check passed"
          else
            echo "âŒ Health check failed"
            exit 1
          fi
