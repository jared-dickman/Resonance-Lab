name: Deploy Backend

on:
  workflow_call:
    inputs:
      environment:
        description: 'Deployment environment (production/development)'
        type: string
        required: true
      branch:
        description: 'Git branch to deploy'
        type: string
        required: true
      container_name:
        description: 'Docker container name (backend/backend-dev)'
        type: string
        required: true
      health_check_url:
        description: 'Health check endpoint URL'
        type: string
        required: true
    secrets:
      VPS_SSH_KEY:
        required: true
      VPS_HOST:
        required: true

jobs:
  deploy-backend:
    name: Deploy Backend to ${{ inputs.environment }}
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ” Validate SSH Key
        run: |
          echo "${{ secrets.VPS_SSH_KEY }}" > /tmp/key && chmod 600 /tmp/key
          ssh-keygen -y -P "" -f /tmp/key > /dev/null 2>&1 || { echo "âŒ Invalid SSH key"; exit 1; }
          rm -f /tmp/key
          echo "âœ… SSH key valid"

      - name: ğŸ–¥ï¸ Deploy Backend to VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: root
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e
            cd /root/Resonance-Lab
            git fetch origin
            git checkout ${{ inputs.branch }}
            git pull origin ${{ inputs.branch }}
            docker compose up -d --build ${{ inputs.container_name }}
            sleep 5
            docker ps | grep -q ${{ inputs.container_name }} || { docker logs ${{ inputs.container_name }} --tail 20; exit 1; }
            echo "âœ… Deployed"

      - name: ğŸ¥ Health Check
        run: |
          sleep 10
          curl -f ${{ inputs.health_check_url }} > /dev/null 2>&1 || { echo "âŒ Health check failed"; exit 1; }
          echo "âœ… Healthy"
