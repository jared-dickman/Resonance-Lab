name: Deploy Backend

on:
  workflow_call:
    inputs:
      environment:
        description: 'Deployment environment (production/development)'
        type: string
        required: true
      branch:
        description: 'Git branch to deploy'
        type: string
        required: true
      container_name:
        description: 'Docker container name (backend/backend-dev)'
        type: string
        required: true
      health_check_url:
        description: 'Health check endpoint URL'
        type: string
        required: true
    secrets:
      VPS_SSH_KEY:
        required: true

jobs:
  deploy-backend:
    name: Deploy Backend to ${{ inputs.environment }}
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ–¥ï¸ Deploy Backend to VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: srv1015344.hstgr.cloud
          username: root
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd /root/Resonance-Lab
            git fetch origin
            git checkout ${{ inputs.branch }}
            git pull origin ${{ inputs.branch }}
            docker-compose up -d --build ${{ inputs.container_name }}
            echo "âœ… Backend deployed to ${{ inputs.environment }} successfully"

      - name: ğŸ¥ Health Check
        run: |
          echo "Waiting 10s for backend to start..."
          sleep 10
          if curl -f ${{ inputs.health_check_url }} > /dev/null 2>&1; then
            echo "âœ… Health check passed"
          else
            echo "âŒ Health check failed"
            exit 1
          fi
